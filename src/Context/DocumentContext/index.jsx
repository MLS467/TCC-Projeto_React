import { useLocation, useNavigate } from "react-router-dom";
import { useEffect, useState } from "react";
import useCrud from "@/Hook/useCrud";
import { toast } from "sonner";
import { DocumentContext } from "./context";
import { v4 } from "uuid";

export const DocumentProvider = ({ children }) => {
  const location = useLocation();
  const navigate = useNavigate();
  const { Insert } = useCrud();
  const [documentId, setDocumentId] = useState(null);

  // Pegar dados do state do router
  const { formData, patientData, endpoint, formType, showTriageOnly } =
    location.state || {};

  // Fun√ß√£o para mapear dados do paciente
  const mapPatientData = (data, formData) => {
    const userData = data?.user || data || {};
    return {
      full_name: userData.name || formData.name || "Nome n√£o informado",
      cpf: userData.cpf || formData.cpf || "CPF n√£o informado",
      email: userData.email || formData.email || "Email n√£o informado",
      gender: userData.sex || formData.sex || "Sexo n√£o informado",
      birth_date: userData.birth || formData.birth || "Data n√£o informada",
      phone: userData.phone || formData.phone || "Telefone n√£o informado",
      city: userData.city || formData.city || "Cidade n√£o informada",
      neighborhood:
        userData.neighborhood ||
        formData.neighborhood ||
        "Bairro n√£o informado",
      street: userData.street || formData.street || "Rua n√£o informada",
      block: userData.apartment || formData.apartment || "N√∫mero n√£o informado",
      apartment:
        userData.apartment || formData.apartment || "Apartamento n√£o informado",
    };
  };

  // Fun√ß√£o para mapear dados de triagem
  const mapTriageData = (data, formData) => ({
    blood_type: data?.blood_type || formData.blood_type || "N√£o informado",
    blood_pressure:
      data?.blood_pressure || formData.blood_pressure || "N√£o informado",
    heart_rate: data?.heart_rate || formData.heart_rate || "N√£o informado",
    respiratory_rate:
      data?.respiratory_rate || formData.respiratory_rate || "N√£o informado",
    oxygen_saturation:
      data?.oxygen_saturation || formData.oxygen_saturation || "N√£o informado",
    temperature: data?.temperature || formData.temperature || "N√£o informado",
    chief_complaint:
      data?.chief_complaint || formData.chief_complaint || "N√£o informado",
    patient_condition:
      data?.patient_condition || formData.patient_condition || "mild",
    bleeding: data?.bleeding || formData.bleeding || 0,
    difficulty_breathing:
      data?.difficulty_breathing || formData.difficulty_breathing || 0,
    edema: data?.edema || formData.edema || 0,
    nausea: data?.nausea || formData.nausea || 0,
    vomiting: data?.vomiting || formData.vomiting || 0,
    allergy: data?.allergy || formData.allergy || "N√£o informado",
    surgery_history:
      data?.surgery_history || formData.surgery_history || "N√£o informado",
  });

  // Fun√ß√£o para mapear dados de consulta
  const mapConsultationData = (formData) => ({
    reason_for_consultation:
      formData.reason_for_consultation || "N√£o informado",
    symptoms: formData.symptoms || "N√£o informado",
    consultation_datetime: formData.date_time || new Date().toISOString(),
    prescribed_medication: formData.prescribed_medication || "N√£o informado",
    medical_recommendations:
      formData.medical_recommendations || "N√£o informado",
    doctor_observations: formData.doctor_observations || "N√£o informado",
    performed_procedures: formData.performed_procedures || "N√£o informado",
    diagnosis: formData.diagnosis || "N√£o informado",
    additional_notes: formData.additional_notes || "N√£o informado",
  });

  // Se n√£o tem dados, redireciona para dashboard
  useEffect(() => {
    if (!formData && formType !== "view-only") {
      toast.error("Nenhum dado de formul√°rio encontrado!");
      navigate("/dashboard");
    }
  }, [formData, formType, navigate]);

  // Fun√ß√£o para confirmar e enviar os dados
  const handleConfirm = async () => {
    if (formType === "consultation") {
      try {
        // Gerar ID √∫nico para o documento/hist√≥rico m√©dico
        const medicalRecordId = v4();
        setDocumentId(medicalRecordId);

        console.log("üöÄ Iniciando processo de confirma√ß√£o da consulta...");
        console.log("üìã ID do documento gerado:", medicalRecordId);

        // 1. Primeira requisi√ß√£o - Dados da consulta
        console.log("üì§ Enviando dados da consulta...");
        const consultationResult = await Insert({
          endpoint,
          data: formData,
        });

        if (!consultationResult.success) {
          throw new Error(
            consultationResult.error || "Erro ao enviar consulta m√©dica!"
          );
        }

        console.log("‚úÖ Consulta enviada com sucesso!");

        // 2. Preparar dados combinados para o hist√≥rico m√©dico
        const { data: patientDbData } = patientData || {};

        const combinedData = {
          id: medicalRecordId,
          ...mapPatientData(patientDbData, formData),
          ...mapTriageData(patientDbData, formData),
          ...mapConsultationData(formData),
        };

        console.log("üì§ Enviando dados para hist√≥rico m√©dico...");
        console.log("üìã Dados combinados:", combinedData);

        // 3. Segunda requisi√ß√£o - Hist√≥rico m√©dico
        const medicalRecordResult = await Insert({
          endpoint: `${import.meta.env.VITE_API_BASE_URL}${
            import.meta.env.VITE_API_MEDICAL_RECORD_ENDPOINT
          }`,
          data: combinedData,
        });

        if (!medicalRecordResult.success) {
          console.warn(
            "‚ö†Ô∏è Erro ao criar hist√≥rico m√©dico:",
            medicalRecordResult.error
          );
          toast.warning(
            "Consulta salva, mas houve erro ao criar hist√≥rico m√©dico"
          );
        } else {
          console.log("‚úÖ Hist√≥rico m√©dico criado com sucesso!");
          toast.success("Consulta e hist√≥rico m√©dico salvos com sucesso!");
        }

        navigate("/success");
      } catch (error) {
        console.error("‚ùå Erro no processo de confirma√ß√£o:", error);
        toast.error(error.message || "Erro ao processar consulta m√©dica!");
      }
    } else {
      // Para outros tipos de formul√°rio
      const result = await Insert({
        endpoint,
        data: formData,
      });

      if (result.success) {
        toast.success("Formul√°rio de triagem enviado com sucesso!");
        navigate("/nurse-patient-list");
      } else {
        toast.error(result.error || "Erro ao enviar formul√°rio de triagem!");
      }
    }
  };

  // Fun√ß√£o para voltar e editarb
  const handleEdit = () => {
    if (formType === "view-only") {
      navigate(-1); // Volta para o consultation form
    } else {
      navigate(-1); // Volta para o form anterior
    }
  };

  // Se n√£o tem dados e n√£o √© view-only, n√£o renderiza os children
  if (!formData && formType !== "view-only") {
    return null;
  }

  const { data } = patientData || {};

  // Dados do paciente - usar dados vindos do contexto ou fallback
  const patientDisplayData =
    patientData && data
      ? {
          name: data?.user?.name || data?.name || "Nome n√£o informado",
          birth: data?.user?.birth || data?.birth || "Data n√£o informada",
          cpf: data?.user?.cpf || data?.cpf || "CPF n√£o informado",
          phone: data?.user?.phone || data?.phone || "Telefone n√£o informado",
          email: data?.user?.email || data?.email || "Email n√£o informado",
          place_of_birth:
            data?.user?.place_of_birth ||
            data?.place_of_birth ||
            "Cidade natal n√£o informada",
          sex: data?.user?.sex || data?.sex || "Sexo n√£o informado",
          zip_code:
            data?.user?.zip_code || data?.zip_code || "CEP n√£o informado",
          city: data?.user?.city || data?.city || "Cidade n√£o informada",
          neighborhood:
            data?.user?.neighborhood ||
            data?.neighborhood ||
            "Bairro n√£o informado",
          street: data?.user?.street || data?.street || "Rua n√£o informada",
          apartment:
            data?.user?.apartment ||
            data?.apartment ||
            "Apartamento n√£o informado",
          age: data?.user?.age || data?.age || "Idade n√£o informada",
        }
      : {
          name:
            formData.first_name && formData.last_name
              ? `${formData.first_name} ${formData.last_name}`
              : formData.name || "Nome n√£o informado",
          birth: formData.birth || "Data n√£o informada",
          cpf: formData.cpf || "CPF n√£o informado",
          phone: formData.phone || "Telefone n√£o informado",
          email: formData.email || "Email n√£o informado",
          place_of_birth:
            formData.place_of_birth || "Cidade natal n√£o informada",
          sex: formData.sex || "Sexo n√£o informado",
          zip_code: formData.zip_code || "CEP n√£o informado",
          city: formData.city || "Cidade n√£o informada",
          neighborhood: formData.neighborhood || "Bairro n√£o informado",
          street: formData.street || "Rua n√£o informada",
          apartment: formData.apartment || "Apartamento n√£o informado",
          age: formData.age || "Idade n√£o informada",
        };

  // Dados de triagem - buscar da API ou dos dados do formul√°rio
  // Para consultation form: busca dados de triagem j√° salvos do banco
  // Para triage form: usa dados do formul√°rio atual
  const triageData = {
    blood_pressure:
      formData.blood_pressure || data?.blood_pressure || "N√£o informado",
    heart_rate: formData.heart_rate || data?.heart_rate || "N√£o informado",
    temperature: formData.temperature || data?.temperature || "N√£o informado",
    oxygen_saturation:
      formData.oxygen_saturation || data?.oxygen_saturation || "N√£o informado",
    respiratory_rate:
      formData.respiratory_rate || data?.respiratory_rate || "N√£o informado",
    chief_complaint:
      formData.chief_complaint || data?.chief_complaint || "N√£o informado",
    patient_condition:
      formData.patient_condition || data?.patient_condition || "mild",
    pain_type: formData.pain_type || data?.pain_type || "N√£o informado",
    pain_scale: formData.pain_scale || data?.pain_scale || "N√£o informado",
    surgery_history:
      formData.surgery_history || data?.surgery_history || "N√£o informado",
    allergy: formData.allergy || data?.allergy || "N√£o informado",
    blood_type: formData.blood_type || data?.blood_type || "N√£o informado",
    emergency_phone:
      formData.emergency_phone || data?.emergency_phone || "N√£o informado",
    responsible_name:
      formData.responsible_name || data?.responsible_name || "N√£o informado",
    difficulty_breathing:
      formData.difficulty_breathing ||
      data?.difficulty_breathing ||
      "N√£o informado",
    nausea: formData.nausea || data?.nausea || "N√£o informado",
    vomiting: formData.vomiting || data?.vomiting || "N√£o informado",
    bleeding: formData.bleeding || data?.bleeding || "N√£o informado",
    edema: formData.edema || data?.edema || "N√£o informado",
  };

  // Dados de consulta
  const consultationData = formData.reason_for_consultation
    ? {
        reason_for_consultation:
          formData.reason_for_consultation || "N√£o informado",
        symptoms: formData.symptoms || "N√£o informado",
        date_time: formData.date_time || "N√£o informado",
        prescribed_medication:
          formData.prescribed_medication || "N√£o informado",
        medical_recommendations:
          formData.medical_recommendations || "N√£o informado",
        doctor_observations: formData.doctor_observations || "N√£o informado",
      }
    : null;

  // Verificar se h√° dados de triagem v√°lidos
  const hasTriageData =
    Object.values(triageData).some((value) => value !== "N√£o informado") ||
    (formType === "consultation" && patientData?.data); // Para consultation, sempre mostrar triagem se houver dados do paciente

  // Verificar se h√° dados de consulta v√°lidos
  const hasConsultationData =
    consultationData &&
    Object.values(consultationData).some((value) => value !== "N√£o informado");

  // Debug: Log dos dados para verifica√ß√£o (pode ser removido em produ√ß√£o)
  console.log("üöÄ DocumentContext - Dados carregados:", {
    formType,
    patientDisplayData,
    triageData: Object.keys(triageData).length,
    consultationData: consultationData
      ? Object.keys(consultationData).length
      : 0,
    hasTriageData,
    hasConsultationData,
  });

  const contextValue = {
    formData,
    patientData,
    patientDisplayData,
    triageData,
    consultationData,
    hasTriageData,
    hasConsultationData,
    formType,
    showTriageOnly,
    documentId,
    handleConfirm,
    handleEdit,
  };

  return (
    <DocumentContext.Provider value={contextValue}>
      {children}
    </DocumentContext.Provider>
  );
};
